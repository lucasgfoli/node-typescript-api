# workflow name 
name: CI 

# trigger the workflow on push or pull request to main or master branches
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# define the jobs to be run in the workflow
jobs:
  build:
    runs-on: ubuntu-latest # machine type

    # define a matrix strategy to test multiple versions of Node.js and MongoDB
    strategy:

      # define the matrix of versions
      matrix:
        node-version: [20.x, 22.x]
        mongo-version: [6.0]

    # steps to be executed in the job
    steps:

      # use the checkout action to clone the repository already created.
      - uses: actions/checkout@v4

      # setup Node.js environment
      - name: Setup Node

      # use the checkout action to clone the repository already created.
        uses: actions/setup-node@v4

        # specify the Node.js version and enable caching for yarn
        with:
          node-version: ${{ matrix.node-version }}
          cache: yarn

      # use the checkout action to clone the repository already created.
      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.4.0
        with:
          mongodb-version: ${{ matrix.mongo-version }}

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn test

      # deploy only on main branch
      - name: Deploy to Render
        if: github.ref == 'refs/heads/main'
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            https://api.render.com/deploy/srv-XXXXXXXX
